<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Status Dashboard</title>
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
  <style>
    /* Basic layout and styles similar to original */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f2f2f2;
      margin: 0; /* Reset default body margin */
    }
    #tab-bar {
      display: flex; /* Use flexbox for tabs */
      margin-bottom: 15px;
      overflow-x: auto; /* Enable horizontal scrolling for many tabs */
    }
    .tab {
      flex-shrink: 0; /* Prevent tabs from shrinking */
      padding: 10px 20px;
      background-color: #e0e0e0;
      margin-right: 5px; /* Reduce right margin */
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap; /* Prevent tab text from wrapping */
      font-size: 0.9em; /* Slightly smaller font */
    }
    .tab.active { background-color: #007BFF; color: white; }
    #status-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px; /* Reduce gap */
    }
    .tab-content {
      display: none;
      flex-wrap: wrap;
      gap: 10px; /* Reduce gap */
      width: 100%; /* Each tab content takes full width initially */
    }
    .tab-content.active { display: flex; }
    .status-box {
      flex: 1 1 280px; /* Slightly smaller base width */
      border: 1px solid #ccc;
      border-radius: 8px; /* Slightly smaller border radius */
      padding: 10px; /* Reduce padding */
      box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow */
      background-color: #fff;
      display: flex;
      flex-direction: column;
      gap: 8px; /* Reduce gap */
      min-width: 0; /* Allows items to shrink below their content size */
    }
    .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .status-name { font-weight: bold; font-size: 1em; } /* Slightly smaller font */
    .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 3px; } /* Smaller indicator */
    .status-active { background-color: #28a745; }
    .status-inactive { background-color: #dc3545; }
    .capabilities { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 3px; } /* Smaller gap and margin */
    .capability { background-color: #eee; border-radius: 4px; padding: 1px 6px; font-size: 0.8em; } /* Smaller padding and font */
    .tabbed-section {
      border-top: 1px solid #ddd;
      padding-top: 3px; /* Reduce padding */
      margin-top: 5px;
    }
    .inner-tabs { display: flex; gap: 8px; margin-bottom: 3px; } /* Reduced gap and margin */
    .inner-tab {
      cursor: pointer;
      padding: 4px 8px; /* Reduced padding */
      border-radius: 4px;
      background-color: #eee;
      font-size: 0.85em;
    }
    .inner-tab.active { background-color: #007BFF; color: white; }
    .inner-content { display: none; }
    .inner-content.active { display: block; }
    .errors-box {
      background-color: #111; color: #0f0; font-family: monospace;
      font-size: 0.8em; padding: 8px; border-radius: 4px;
      max-height: 120px; overflow-y: auto;
    }
    .camera-stream {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 4px;
      background-color: #ccc;
      display: block; /* Prevent extra bottom space */
    }
    .timers {
      display: flex;
      flex-wrap: wrap;
      gap: 3px; /* Reduce gap */
      margin-top: 3px; /* Reduce margin */
      font-size: 0.8em;
    }
    .timer {
      background-color: #f1f1f1;
      border-radius: 15px; /* Smaller border radius */
      padding: 2px 8px; /* Reduced padding */
    }
  </style>
</head>
<body>
  <h1>Status Dashboard</h1>
  <div class="tabs" id="tab-bar"></div>
  <div id="status-container"></div>
  <script>
    const socket = io('http://localhost:9000', { transports: ['websocket'], upgrade: false });

    const statusBoxes = new Map();
    const groupContainers = new Map();
    let activeTab = null;

    function createElement(tag, className, text) {
      const el = document.createElement(tag);
      if (className) el.className = className;
      if (text) el.textContent = text;
      return el;
    }

    function createOrGetGroupContainer(prefix) {
      if (!groupContainers.has(prefix)) {
        const container = createElement('div', 'tab-content');
        container.dataset.tab = prefix;
        document.getElementById('status-container').appendChild(container);

        const tab = createElement('div', 'tab', prefix);
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          container.classList.add('active');
          activeTab = prefix;
        });
        document.getElementById('tab-bar').appendChild(tab);
        groupContainers.set(prefix, container);

        if (!activeTab) {
          tab.click();
        }
      }
      return groupContainers.get(prefix);
    }

    function updateOrCreateStatusBox(status) {
      const key = status.name;
      const prefix = status.group || 'Default';
      const container = createOrGetGroupContainer(prefix);

      if (!statusBoxes.has(key)) {
        const boxObj = createStatusBox(status);
        container.appendChild(boxObj.container);
        statusBoxes.set(key, boxObj);
      } else {
        const boxObj = statusBoxes.get(key);
        updateStatusBox(boxObj, status);
      }
    }

    function createStatusBox(status) {
      const box = createElement('div', 'status-box');
      box.dataset.activeTab = 'errors';

      const header = createElement('div', 'status-header');
      const nameDiv = createElement('div', 'status-name', status.name);
      const indicator = createElement('span', 'status-indicator');
      const statusText = createElement('div', 'status-text', status.status);
      header.append(indicator, nameDiv, statusText);

      const description = createElement('div', 'description', status.description);

      const capabilities = createElement('div', 'capabilities');
      (status.capabilites || ['None']).forEach(cap => capabilities.appendChild(createElement('span', 'capability', cap)));

      const tabbedSection = createElement('div', 'tabbed-section');
      const innerTabs = createElement('div', 'inner-tabs');
      const errorsTab = createElement('div', 'inner-tab active', 'Errors');
      errorsTab.dataset.tab = 'errors';
      innerTabs.appendChild(errorsTab);

      let streamContent = null;

      if (status.streamIp) {
        // Create the camera tab
        const cameraTab = createElement('div', 'inner-tab', 'Camera');
        cameraTab.dataset.tab = 'stream';
        innerTabs.appendChild(cameraTab);

        // Create the content area for the video stream
        streamContent = createElement('div', 'inner-content stream-content');
        streamContent.dataset.tab = 'stream';

        const img = createElement('img', 'camera-stream');

        document.addEventListener('visibilitychange', () => {
          if (!img) return;
          const isCameraTabVisible = streamContent?.classList.contains('active');
          if (document.hidden || !isCameraTabVisible) {
            img.src = "";
          } else {
            img.src = status.streamIp;
          }
        });

        img.dataset.lastIp = status.streamIp;
        streamContent.appendChild(img);
      }



      const errorsContent = createElement('div', 'inner-content errors-content active');
      errorsContent.dataset.tab = 'errors';
      const errorsBox = createElement('div', 'errors-box', status.errors || 'None');
      errorsContent.appendChild(errorsBox);

      tabbedSection.append(innerTabs, errorsContent);
      if (streamContent) tabbedSection.appendChild(streamContent);

      const timers = createElement('div', 'timers');
      const timerCreate = createElement('span', 'timer');
      const timerPeriodic = createElement('span', 'timer');
      const timerShutdown = createElement('span', 'timer');
      const timerClose = createElement('span', 'timer');
      timers.append(timerCreate, timerPeriodic, timerShutdown, timerClose);

      box.append(header, description, capabilities, tabbedSection, timers);

      innerTabs.addEventListener('click', function(event) {
      const target = event.target;
      if (target.classList.contains('inner-tab')) {
        const tabId = target.dataset.tab;

        // Remove active class from all tabs and contents
        innerTabs.querySelectorAll('.inner-tab').forEach(t => t.classList.remove('active'));
        tabbedSection.querySelectorAll('.inner-content').forEach(content => {
          content.classList.remove('active');
        });

        // Set active tab and content
        target.classList.add('active');
        const activeContent = tabbedSection.querySelector(`.inner-content[data-tab="${tabId}"]`);
        if (activeContent) activeContent.classList.add('active');

        box.dataset.activeTab = tabId;

        // If it's the stream tab, set img.src, otherwise clear it
        if (tabId === 'stream' && boxObj.streamImg) {
          boxObj.streamImg.src = boxObj.streamImg.dataset.lastIp;
        } else if (boxObj.streamImg) {
          boxObj.streamImg.src = '';
        }
      }
      });


      const boxObj = { container: box, indicator, statusText, description, errorsBox, streamImg: streamContent?.querySelector('img'), timerCreate, timerPeriodic, timerShutdown, timerClose };
      updateStatusBox(boxObj, status);
      return boxObj;
    }

    // Update function: only patches the parts that change.
      function updateStatusBox(boxObj, status) {
        // Update indicator if status changed
        const isActive = status.active.toLowerCase() === 'active';
        const newClass = 'status-indicator ' + (isActive ? 'status-active' : 'status-inactive');
        if (boxObj.indicator.className !== newClass) {
          boxObj.indicator.className = newClass;
        }

        // Update status text if changed
        if (boxObj.statusText.textContent !== status.status) {
          boxObj.statusText.textContent = status.status;
        }

        // Update description if changed
        if (boxObj.description.textContent !== status.description) {
          boxObj.description.textContent = status.description;
        }

        // Update errors if changed
        if (boxObj.errorsBox.textContent !== status.errors) {
          boxObj.errorsBox.textContent = status.errors || 'None';
        }

        // PROBLEM !

        // Update camera stream only if IP changed
        // if (boxObj.streamImg && boxObj.streamImg.dataset.lastIp !== status.streamIp) {
        //   boxObj.streamImg.src = status.streamIp;
        //   boxObj.streamImg.dataset.lastIp = status.streamIp;
        // }

        // Update timers only if changed
        const format = val => (val !== undefined && val >= 0) ? val.toFixed(2) : 'N/A';
        const timerValues = {
          timerCreate: `create: ${format(status.create)}`,
          timerPeriodic: `runPeriodic: ${format(status.runPeriodic)}`,
          timerShutdown: `shutdown: ${format(status.shutdown)}`,
          timerClose: `close: ${format(status.close)}`
        };

        for (const [key, val] of Object.entries(timerValues)) {
          if (boxObj[key].textContent !== val) {
            boxObj[key].textContent = val;
          }
        }
      }


    socket.on('status_update', data => {
      data.forEach(status => {
        const group = status.group || 'default';
        if (!groupContainers.has(group)) {
          const container = document.createElement('div');
          container.className = 'tab-content';
          groupContainers.set(group, container);
          document.getElementById('status-container').appendChild(container);

          // Create a tab for this group
          const tab = createElement('div', 'tab', group);
          tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            container.classList.add('active');
            activeTab = group;
          });
          document.getElementById('tab-bar').appendChild(tab);

          // Activate first tab
          if (!activeTab) {
            tab.click();
          }
        }

        const key = status.name;
        if (!statusBoxes.has(key)) {
          const boxObj = createStatusBox(status);
          groupContainers.get(group).appendChild(boxObj.container);
          statusBoxes.set(key, boxObj);
        }
         else {
          const boxObj = statusBoxes.get(key);
          updateStatusBox(boxObj, status);
        }
      });
    });

  </script>
</body>
</html>
