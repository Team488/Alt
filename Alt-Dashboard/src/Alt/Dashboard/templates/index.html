<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Status Dashboard</title>
  <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f2f2f2;
    }
    .tabs {
      margin-bottom: 20px;
    }
    .tab {
      display: inline-block;
      padding: 10px 20px;
      background-color: #e0e0e0;
      margin-right: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .tab.active {
      background-color: #007BFF;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .status-box {
      flex: 1 1 300px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      background-color: #fff;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-name {
      font-weight: bold;
      font-size: 1.1em;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .status-active {
      background-color: #28a745;
    }
    .status-inactive {
      background-color: #dc3545;
    }
    .capabilities {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .capability {
      background-color: #eee;
      border-radius: 5px;
      padding: 2px 8px;
      font-size: 0.85em;
    }
    .tabbed-section {
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
      padding-top: 5px;
    }
    .inner-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 5px;
    }
    .inner-tab {
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 5px;
      background-color: #eee;
    }
    .inner-tab.active {
      background-color: #007BFF;
      color: white;
    }
    .inner-content {
      display: none;
    }
    .inner-content.active {
      display: block;
    }
    .errors-box {
      background-color: #111;
      color: #0f0;
      font-family: monospace;
      font-size: 0.9em;
      padding: 10px;
      border-radius: 5px;
      max-height: 150px;
      overflow-y: auto;
    }
    .camera-stream {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 5px;
      background-color: #ccc;
    }
    .timers {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }
    .timer {
      background-color: #f1f1f1;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 0.85em;
    }
  </style>
</head>
<body>
  <h1>Status Dashboard</h1>
  <div class="tabs" id="tab-bar"></div>
  <div id="status-container"></div>

  <script>
    const socket = io('http://localhost:9000');

    // Maps to track the current DOM elements
    const existingStatuses = new Map();   // key: full name, value: status box DOM element
    const groupContainers = new Map();     // key: prefix, value: group container DOM element
    const streamIntervals = new Map();     // key: status name, value: interval ID

    socket.on('connect', () => {
      console.log("Connected to server");
    });

    function startMJPEGStream(streamIp, imgElementId) {
      function updateImage() {
        const imgElement = document.getElementById(imgElementId);
        if (imgElement) {
          imgElement.src = `${streamIp}?timestamp=${Date.now()}`;
        } else {
          clearInterval(streamIntervals.get(imgElementId.split('-').pop())); // Stop if element is removed
          streamIntervals.delete(imgElementId.split('-').pop());
        }
      }
      const intervalId = setInterval(updateImage, 100);
      streamIntervals.set(imgElementId.split('-').pop(), intervalId);
    }

    function stopMJPEGStream(statusName) {
      if (streamIntervals.has(statusName)) {
        clearInterval(streamIntervals.get(statusName));
        streamIntervals.delete(statusName);
      }
    }

    // Helper: render the inner HTML for a status box.
    // Use stored activeTab state so that we don’t lose the user’s selection.
    function renderStatusBoxHTML(status, activeTab) {
      const isActive = status.active.toLowerCase() === 'active';
      const capabilities = (status.capabilites || []).length > 0
                          ? (status.capabilites || []).map(cap =>
                              `<span class="capability">${cap}</span>`).join('')
                          : '<span class="capability">None</span>';

      const streamTab = status.streamIp ? `
          <div class="inner-tab ${activeTab === 'stream' ? 'active' : ''}" data-tab="stream">Camera</div>
      ` : '';

      const streamContent = status.streamIp ? `
          <div class="inner-content ${activeTab === 'stream' ? 'active' : ''}" data-tab="stream">
              <img class="camera-stream" id="camera-stream-${status.name}" src="${status.streamIp}" alt="Camera Stream">
          </div>
      ` : '';

      return `
        <div class="status-header">
          <div class="status-name">
            <span class="status-indicator ${isActive ? 'status-active' : 'status-inactive'}"></span>
            ${status.displayName}
          </div>
          <div>${status.status}</div>
        </div>
        <div>${status.description}</div>
        <div class="capabilities">${capabilities}</div>

        <div class="tabbed-section">
          <div class="inner-tabs">
            <div class="inner-tab ${activeTab === 'errors' ? 'active' : ''}" data-tab="errors">Errors</div>
            ${streamTab}
          </div>
          <div class="inner-content ${activeTab === 'errors' ? 'active' : ''}" data-tab="errors">
            <div class="errors-box">${status.errors || 'None'}</div>
          </div>
          ${streamContent}
        </div>

        <div class="timers">
          <span class="timer">create: ${status.create.toFixed(2)}</span>
          <span class="timer">runPeriodic: ${status.runPeriodic.toFixed(2)}</span>
          <span class="timer">shutdown: ${status.shutdown.toFixed(2)}</span>
          <span class="timer">close: ${status.close >= 0 ? status.close.toFixed(2) : 'N/A'}</span>
        </div>
      `;
    }

    // Helper: attach click event listeners for inner tabs within a status box.
    function attachInnerTabHandlers(box) {
      const tabButtons = box.querySelectorAll('.inner-tab');
      const tabContents = box.querySelectorAll('.inner-content');

      tabButtons.forEach((btn) => {
        btn.onclick = () => {
          const selectedTab = btn.dataset.tab;
          box.setAttribute('data-active-tab', selectedTab);
          tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === selectedTab));
          tabContents.forEach(c => c.classList.toggle('active', c.dataset.tab === selectedTab));

          // Start MJPEG stream when the camera tab becomes active
          const statusName = box.querySelector('.camera-stream')?.id.split('-').pop();
          const streamIp = box.querySelector('.camera-stream')?.src.split('?')[0]; // Get base URL
          if (selectedTab === 'stream' && streamIp && !streamIntervals.has(statusName)) {
            startMJPEGStream(streamIp, `camera-stream-${statusName}`);
          } else if (selectedTab !== 'stream' && statusName) {
            stopMJPEGStream(statusName);
          }
        };
      });

      // Initialize active tab on load if set
      const activeInnerTab = box.getAttribute('data-active-tab') || 'errors';
      tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === activeInnerTab));
      tabContents.forEach(content => content.classList.toggle('active', content.dataset.tab === activeInnerTab));

      // Start MJPEG stream if the initial active tab is 'stream'
      const initialStatusName = box.querySelector('.camera-stream')?.id.split('-').pop();
      const initialStreamIp = box.querySelector('.camera-stream')?.src.split('?')[0];
      if (activeInnerTab === 'stream' && initialStreamIp && !streamIntervals.has(initialStatusName)) {
        startMJPEGStream(initialStreamIp, `camera-stream-${initialStatusName}`);
      }
    }

    socket.on('status_update', function (statuses) {
      const container = document.getElementById('status-container');
      const tabBar = document.getElementById('tab-bar');

      const grouped = {};
      const newStatusNames = new Set();

      statuses.forEach((status) => {
        const [prefix, name] = status.name.split('.');
        if (!grouped[prefix]) grouped[prefix] = [];
        status.displayName = name;
        grouped[prefix].push(status);
        newStatusNames.add(status.name);
      });

      // Stop MJPEG streams for removed statuses
      for (const name of existingStatuses.keys()) {
        if (!newStatusNames.has(name)) {
          const el = existingStatuses.get(name);
          const statusName = el.querySelector('.camera-stream')?.id.split('-').pop();
          if (statusName) {
            stopMJPEGStream(statusName);
          }
          el.parentNode && el.parentNode.removeChild(el);
          existingStatuses.delete(name);
        }
      }

      // --- Update Tab Groups (for prefixes) ---
      const existingTabs = Array.from(tabBar.children).map(tab => tab.dataset.prefix);
      const newPrefixes = Object.keys(grouped);

      newPrefixes.forEach(prefix => {
        if (!groupContainers.has(prefix)) {
          const tab = document.createElement('div');
          tab.className = 'tab' + (tabBar.children.length === 0 ? ' active' : '');
          tab.innerText = prefix;
          tab.dataset.prefix = prefix;
          tab.onclick = () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`content-${prefix}`).classList.add('active');
          };
          tabBar.appendChild(tab);

          const groupDiv = document.createElement('div');
          groupDiv.className = 'tab-content' + (tab.classList.contains('active') ? ' active' : '');
          groupDiv.id = `content-${prefix}`;
          container.appendChild(groupDiv);

          groupContainers.set(prefix, groupDiv);
        }
      });

      for (let [prefix, groupDiv] of groupContainers.entries()) {
        if (!grouped[prefix] || grouped[prefix].length === 0) {
          groupDiv.parentNode && groupDiv.parentNode.removeChild(groupDiv);
          groupContainers.delete(prefix);
          const tabToRemove = tabBar.querySelector(`[data-prefix="${prefix}"]`);
          tabToRemove && tabToRemove.parentNode.removeChild(tabToRemove);
        }
      }

      // --- Update/Add Each Status Box ---
      Object.entries(grouped).forEach(([prefix, statuses]) => {
        const groupDiv = groupContainers.get(prefix);
        statuses.forEach((status) => {
          let box = existingStatuses.get(status.name);
          let activeTab = 'errors';
          if (box && box.hasAttribute('data-active-tab')) {
            activeTab = box.getAttribute('data-active-tab');
          }

          const newInnerHTML = renderStatusBoxHTML(status, activeTab);

          if (box) {
            if (box.innerHTML !== newInnerHTML) {
              // Stop existing stream before updating content
              const existingStatusName = box.querySelector('.camera-stream')?.id.split('-').pop();
              if (existingStatusName) {
                stopMJPEGStream(existingStatusName);
              }
              box.innerHTML = newInnerHTML;
              attachInnerTabHandlers(box);
            }
          } else {
            box = document.createElement('div');
            box.className = 'status-box';
            box.setAttribute('data-active-tab', activeTab);
            box.innerHTML = newInnerHTML;
            groupDiv.appendChild(box);
            existingStatuses.set(status.name, box);
            attachInnerTabHandlers(box);
          }

          // Ensure MJPEG stream starts if the camera tab is active after update
          if (status.streamIp && box && box.getAttribute('data-active-tab') === 'stream' && !streamIntervals.has(status.name)) {
            startMJPEGStream(status.streamIp, `camera-stream-${status.name}`);
          } else if (!status.streamIp && box && streamIntervals.has(status.name)) {
            stopMJPEGStream(status.name);
          }
        });
      });
    });
  </script>
</body>
</html>